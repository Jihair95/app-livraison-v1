<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suivi Livraisons - Chauffeur Pro v18.7</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-800: #1f2937;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--gray-100); color: var(--gray-800); padding-bottom: 80px; }
        .app-container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; position: relative; }
        header { background: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        header h1 { margin: 0; font-size: 1.2rem; font-weight: 600; }
        .btn-logout { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        #login-screen { display: flex; flex-direction: column; justify-content: center; height: 100vh; padding: 2rem; text-align: center; background: var(--primary); color: white; }
        .login-card { background: white; color: var(--gray-800); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 1rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 1rem; }
        .btn-primary { width: 100%; background: var(--primary); color: white; border: none; padding: 0.85rem; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .btn-primary:active { background: var(--primary-dark); transform: scale(0.98); }
        .filters { padding: 1rem; background: white; border-bottom: 1px solid var(--gray-200); display: flex; gap: 0.5rem; overflow-x: auto; }
        .filters::-webkit-scrollbar { display: none; }
        .filter-btn { padding: 0.5rem 1rem; border: 1px solid var(--gray-200); border-radius: 20px; background: white; white-space: nowrap; cursor: pointer; font-size: 0.9rem; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .delivery-list { padding: 1rem; }
        .card { background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid transparent; cursor: pointer; transition: transform 0.1s; }
        .card:active { transform: scale(0.98); }
        .card.status-pending { border-left-color: var(--warning); }
        .card.status-assigned { border-left-color: var(--primary); }
        .card.status-picked_up { border-left-color: #8b5cf6; }
        .card.status-delivered { border-left-color: var(--success); }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .badge-pending { background: #fef3c7; color: #d97706; }
        .badge-assigned { background: #dbeafe; color: #2563eb; }
        .badge-picked_up { background: #ede9fe; color: #7c3aed; }
        .badge-delivered { background: #d1fae5; color: #059669; }
        .card-route { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: #4b5563; margin: 0.5rem 0; }
        .arrow-icon { color: var(--gray-200); }
        #detail-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 20; overflow-y: auto; }
        .nav-back { padding: 1rem; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; background: white; cursor: pointer; }
        .detail-content { padding: 1rem; }
        .info-block { margin-bottom: 1.5rem; }
        .info-block h3 { margin: 0 0 0.5rem 0; font-size: 1rem; color: var(--primary); }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.95rem; border-bottom: 1px dashed var(--gray-200); padding-bottom: 0.25rem; align-items: flex-start; }
        .info-label { color: #6b7280; margin-top: 0.2rem; }
        .info-val-container { flex: 1; text-align: right; }
        .info-val { font-weight: 500; color: var(--gray-800); }
        .info-input { width: 100%; padding: 0.5rem; border: 1px solid var(--primary); border-radius: 6px; font-size: 0.95rem; text-align: right; color: var(--primary); outline: none; }
        .action-area { background: var(--gray-100); padding: 1rem; text-align: center; margin-top: 2rem; border-radius: 8px; }
        .btn-action { width: 100%; padding: 1rem; font-size: 1.1rem; margin-bottom: 0.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-action:active { transform: scale(0.98); }
        .btn-assign { background: var(--primary); color: white; }
        .btn-pickup { background: #7c3aed; color: white; }
        .btn-deliver { background: var(--success); color: white; }
        .btn-cmr { background: #333; color: white; margin-top: 1rem; }
        .btn-edit { background: #f59e0b; color: white; display: block; margin-top: 0.5rem; width: 100%; padding: 0.75rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
        .btn-save { background: var(--success); color: white; margin-top: 0.5rem; width: 100%; padding: 0.75rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
        .btn-cancel { background: var(--danger); color: white; margin-top: 0.5rem; width: 100%; padding: 0.75rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
        #wizard-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 30; flex-direction: column; }
        .wizard-header { padding: 1rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
        .wizard-steps { display: flex; justify-content: space-between; padding: 1rem; background: var(--gray-100); }
        .wizard-steps::-webkit-scrollbar { display: none; }
        .step { font-size: 0.8rem; color: #9ca3af; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .step.active { color: var(--primary); font-weight: bold; }
        .step.completed { color: var(--success); }
        .step-circle { width: 24px; height: 24px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; }
        .step.active .step-circle { background: var(--primary); }
        .step.completed .step-circle { background: var(--success); }
        .wizard-body { flex: 1; padding: 1rem; overflow-y: auto; }
        .form-section { display: none; animation: fadeIn 0.3s; }
        .form-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .photo-upload-area { border: 2px dashed var(--primary); border-radius: 8px; padding: 2rem; text-align: center; background: #eff6ff; color: var(--primary); cursor: pointer; margin-bottom: 1rem; position: relative; }
        .photo-preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 1rem; }
        .photo-thumb { width: 100%; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid var(--gray-200); position: relative; }
        .signature-pad-wrapper { border: 2px solid var(--gray-200); border-radius: 8px; background: #fff; margin-bottom: 1rem; position: relative; width: 100%; height: 200px; touch-action: none; }
        .signature-pad-wrapper canvas { display: block; width: 100% !important; height: 100% !important; position: absolute; top: 0; left: 0; }
        .sig-controls { display: flex; justify-content: flex-end; margin-bottom: 1rem; }
        .btn-clear { background: white; border: 1px solid var(--danger); color: var(--danger); padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
        .wizard-footer { padding: 1rem; border-top: 1px solid var(--gray-200); display: flex; gap: 0.5rem; align-items: center; }
        .btn-secondary { background: white; border: 1px solid var(--gray-200); color: var(--gray-800); flex: 1; padding: 0.75rem; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-next { background: var(--primary); color: white; border: none; flex: 2; padding: 0.75rem; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 0.75rem; border-radius: 6px; font-weight: 600; cursor: pointer; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: opacity 0.3s; }
        #toast.show { visibility: visible; opacity: 1; }
        .hidden { display: none !important; }
        .text-sm { font-size: 0.85rem; color: #6b7280; }
        .mt-2 { margin-top: 0.5rem; }
        #cmr-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 50; overflow-y: auto; padding: 1rem; font-size: 12px; color: #000; }
        .cmr-header-action { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #ccc; padding-bottom: 1rem; }
        .cmr-container { max-width: 800px; margin: 0 auto; border: 2px solid #000; padding: 1.5rem; background: #fff; }
        .cmr-header { text-align: center; margin-bottom: 1rem; border-bottom: 2px solid #000; padding-bottom: 0.5rem; }
        .cmr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem; }
        .cmr-full { grid-column: span 2; }
        .cmr-box { border: 1px solid #ccc; padding: 0.3rem; }
        .cmr-label { font-weight: bold; font-size: 0.7rem; color: #333; display: block; margin-bottom: 0.2rem; text-transform: uppercase; }
        .cmr-value { font-size: 0.85rem; line-height: 1.2; }
        .cmr-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; margin-bottom: 0.5rem; font-size: 0.8rem; }
        .cmr-table th, .cmr-table td { border: 1px solid #000; padding: 3px; text-align: left; }
        .cmr-table th { background-color: #f0f0f0; }
        .cmr-sig-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-top: 1rem; }
        .cmr-sig-box { border: 1px dashed #999; padding: 0.2rem; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; text-align: center; }
        .cmr-sig-img { max-height: 80px; max-width: 100%; margin-bottom: 5px; }
        .cmr-placeholder { color: #999; font-size: 0.7rem; font-style: italic; }
        .page-break { page-break-before: always; }
        .cmr-photos-page { margin-top: 2rem; }
        .cmr-photos-header { text-align: center; margin: 2rem 0 1rem 0; }
        .photos-section { margin-bottom: 2rem; }
        .photo-grid-large { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin: 1rem 0; padding: 1rem; border: 2px dashed #ddd; border-radius: 8px; background: #f9fafb; }
        .photo-grid-large img { width: 100%; height: 250px; object-fit: cover; border: 2px solid #ccc; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .remarks-section { margin-top: 2rem; padding: 1.5rem; background: #fff; border: 2px solid #f59e0b; border-radius: 8px; }
        .remarks-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .remark-item { padding: 1rem; background: #fffbeb; border-left: 4px solid #f59e0b; border-radius: 4px; }
        .remark-label { font-weight: bold; color: #92400e; display: block; margin-bottom: 0.25rem; font-size: 0.9rem; }
        .remark-value { color: #000; font-size: 1rem; }
        .no-print { display: block; }
        @media print { body * { visibility: hidden; } #cmr-view, #cmr-view * { visibility: visible; } #cmr-view { position: absolute; left: 0; top: 0; width: 100%; height: auto; overflow: visible; border: none; padding: 0; } .no-print { display: none !important; } .cmr-container { border: none; box-shadow: none; margin: 0; padding: 0; } .page-break { page-break-before: always; margin-top: 2cm; } .photo-grid-large { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; } .photo-grid-large img { height: 200px !important; border: 1px solid #000 !important; } .photos-section, .remarks-section { break-inside: avoid; } }
        .debug-btn { background: #8b5cf6; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-left: 5px; cursor: pointer; font-size: 0.8rem; }
        .sync-status { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px; background: #f3f4f6; }
        .sync-status.online { background: #d1fae5; color: #059669; }
        .sync-status.offline { background: #fef3c7; color: #d97706; }
        .note-badge { background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; margin-left: 5px; }
        @media (max-width: 480px) { .filters { padding: 0.75rem; } .filter-btn { padding: 0.4rem 0.8rem; font-size: 0.8rem; } .card { padding: 0.75rem; } .wizard-steps { padding: 0.5rem; } .step { font-size: 0.7rem; } .step-circle { width: 20px; height: 20px; } .photo-grid-large { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="toast">Message</div>
    <div id="login-screen">
        <div class="login-card">
            <h2 style="margin-top:0">Connexion Chauffeur</h2>
            <div class="input-group">
                <label>Votre Identifiant (Ex: Chauffeur 1)</label>
                <input type="text" id="login-id" placeholder="Chauffeur 1">
            </div>
            <button class="btn-primary" onclick="app.login()">D√©marrer la journ√©e</button>
        </div>
    </div>
    <div id="app-container" class="app-container hidden">
        <header>
            <h1 id="header-title">Livraisons</h1>
            <div>
                <span id="sync-indicator" class="sync-status online">En ligne</span>
                <button class="debug-btn" onclick="app.forceReloadFromSheet()">üîÑ Recharger</button>
                <button class="btn-logout" onclick="app.logout()">D√©connexion</button>
            </div>
        </header>
        <main>
            <div class="filters" id="filter-container">
                <button class="filter-btn active" onclick="app.setFilter('all')">Toutes</button>
                <button class="filter-btn" onclick="app.setFilter('pending')">√Ä enlever</button>
                <button class="filter-btn" onclick="app.setFilter('assigned')">Assign√©es</button>
                <button class="filter-btn" onclick="app.setFilter('picked_up')">En transit</button>
                <button class="filter-btn" onclick="app.setFilter('delivered')">Livr√©es</button>
            </div>
            <div id="delivery-list" class="delivery-list"></div>
        </main>
    </div>
    <div id="detail-view">
        <div class="nav-back" onclick="app.closeDetail()">‚Üê Retour</div>
        <div class="detail-content" id="detail-content"></div>
    </div>
    <div id="wizard-overlay">
        <div class="wizard-header">
            <h3 id="wizard-title">Processus</h3>
            <button style="background:none;border:none;font-size:1.5rem;color:#6b7280;cursor:pointer;" onclick="app.closeWizard()">√ó</button>
        </div>
        <div class="wizard-steps" id="wizard-steps"></div>
        <div class="wizard-body">
            <div id="step-1" class="form-section">
                <h3>üì∏ Photos du colis</h3>
                <p class="text-sm">Prenez des photos claires du colis (√©tat, √©tiquette).</p>
                <div class="photo-upload-area" onclick="document.getElementById('camera-input').click()">
                    <span>üì∑ Appuyer pour prendre une photo</span>
                    <input type="file" id="camera-input" accept="image/*" capture="environment" multiple style="display:none" onchange="app.handlePhotoUpload(this)">
                </div>
                <div id="photo-preview" class="photo-preview-grid"></div>
            </div>
            <div id="step-2-details" class="form-section">
                <h3>üì¶ D√©tails du Colis</h3>
                <div class="input-group"><label>Nature de la marchandise</label><textarea id="cargo-nature" rows="2" placeholder="Ex: 10 Cartons Livres Fragiles"></textarea></div>
                <div class="input-group"><label>Poids de la cargaison (kg)</label><input type="number" id="cargo-weight" placeholder="Ex: 150"></div>
                <div class="input-group"><label>Remarques</label><input type="text" id="cargo-remarks" placeholder="Ex: Fragile..."></div>
                <div style="margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 6px;"><h4 style="margin:0 0 0.5rem 0;">Colis charg√©s (<span id="cargo-count">0</span>)</h4><ul id="added-cargo-list" style="padding-left: 1.2rem; margin:0; font-size: 0.9rem; color: #555;"></ul></div>
                <button class="btn-primary" style="background: var(--warning); color: white; margin-top: 0.5rem; border: none; padding: 0.5rem; border-radius: 4px; width: 100%; font-size: 0.9rem; cursor: pointer;" onclick="app.addCargoToManifest()">+ Ajouter colis</button>
            </div>
            <div id="step-3-transport" class="form-section">
                <h3>üöö Info V√©hicule & Transporteur</h3>
                <div class="input-group"><label>Plaque d'immatriculation</label><input type="text" id="truck-plate" placeholder="Ex: 123 AB 45"></div>
                <div class="input-group"><label>Nom du chauffeur</label><input type="text" id="driver-name-cmr" readonly style="background:var(--gray-100)"></div>
            </div>
            <div id="step-4-sender" class="form-section">
                <h3>‚úçÔ∏è Signature Exp√©diteur</h3>
                <div class="input-group"><label>Nom de l'exp√©diteur</label><input type="text" id="sender-name" placeholder="Nom complet"></div>
                <div class="signature-pad-wrapper"><canvas id="sig-sender" class="signature-pad"></canvas></div>
                <div class="sig-controls"><button class="btn-clear" onclick="app.clearSignature('sig-sender')">Effacer</button></div>
            </div>
            <div id="step-5-driver" class="form-section">
                <h3>üöö Signature Chauffeur (CMR)</h3>
                <div class="info-block" style="background:#eff6ff; padding:1rem; border-radius:8px; margin-bottom:1rem;"><p class="text-sm"><strong>Lettre de Voiture Num√©rique</strong><br>En signant, le chauffeur atteste avoir pris en charge le colis en bon √©tat.</p></div>
                <div class="input-group"><label>Votre nom (Chauffeur)</label><input type="text" id="driver-name-sig" readonly style="background:var(--gray-100)"></div>
                <div class="signature-pad-wrapper"><canvas id="sig-driver" class="signature-pad"></canvas></div>
                <div class="sig-controls"><button class="btn-clear" onclick="app.clearSignature('sig-driver')">Effacer</button></div>
            </div>
            <div id="step-2-recipient" class="form-section">
                <h3>üìã Signature Destinataire</h3>
                <div class="input-group"><label>Nom du destinataire</label><input type="text" id="recipient-name" placeholder="Nom complet"></div>
                <div class="signature-pad-wrapper"><canvas id="sig-recipient" class="signature-pad"></canvas></div>
                <div class="sig-controls"><button class="btn-clear" onclick="app.clearSignature('sig-recipient')">Effacer</button></div>
            </div>
            <div id="step-3-remarks" class="form-section">
                <h3>üìù Remarques & R√©serves</h3>
                <div class="info-block" style="background:#fff3cd;border-left:4px solid #ffc107;padding:1rem;border-radius:4px;margin-bottom:1rem;"><p style="margin:0;color:#856404;"><strong>Important :</strong> Indiquez ici toute r√©serve concernant l'√©tat de la marchandise, le retard, ou tout probl√®me constat√© lors de la livraison.</p></div>
                <div class="input-group"><label>√âtat de la marchandise</label><select id="delivery-condition" class="info-input" style="width:100%;padding:0.75rem;"><option value="bon">‚úÖ Bon √©tat</option><option value="endommage">‚ö†Ô∏è L√©g√®rement endommag√©</option><option value="tres_endommage">‚ùå Tr√®s endommag√©</option><option value="manquant">üì¶ Pi√®ce(s) manquante(s)</option></select></div>
                <div class="input-group"><label>Remarques d√©taill√©es</label><textarea id="delivery-remarks" rows="4" placeholder="D√©crivez les r√©serves constat√©es, l'√©tat exact, les probl√®mes..."></textarea></div>
                <div class="input-group"><label>Heure d'arriv√©e r√©elle</label><input type="time" id="actual-arrival-time" class="info-input"></div>
                <div class="input-group"><label>Nom de la personne ayant r√©ceptionn√©</label><input type="text" id="received-by" placeholder="Nom et pr√©nom"></div>
                <div class="input-group"><label>Pi√®ce d'identit√© v√©rifi√©e ?</label><select id="id-verified" class="info-input" style="width:100%;padding:0.75rem;"><option value="oui">‚úÖ Oui</option><option value="non">‚ùå Non</option><option value="refus">üö´ A refus√©</option></select></div>
            </div>
        </div>
        <div class="wizard-footer">
            <button class="btn-danger" id="btn-cancel" onclick="app.closeWizard()">Annuler</button>
            <button class="btn-secondary" id="btn-prev" onclick="app.prevStep()">Pr√©c√©dent</button>
            <button class="btn-next" id="btn-next" onclick="app.nextStep()">Suivant</button>
        </div>
    </div>
    <div id="cmr-view">
        <div class="cmr-header-action no-print">
            <button class="btn-secondary" onclick="document.getElementById('cmr-view').style.display='none'">‚Üê Retour</button>
            <button class="btn-primary" onclick="window.print()">üñ®Ô∏è Imprimer / PDF</button>
        </div>
        <div class="cmr-container">
            <div class="cmr-header"><h1 style="margin:0; font-size:1.2rem;">LETTRE DE VOITURE (CMR)</h1><p style="margin:5px 0"><strong>R√©f√©rence:</strong> <span id="cmr-ref"></span></p></div>
            <div class="cmr-grid">
                <div class="cmr-box"><span class="cmr-label">1. EXP√âDITEUR</span><div class="cmr-value" id="cmr-sender-addr"></div><div class="cmr-value" id="cmr-sender-contact"></div></div>
                <div class="cmr-box"><span class="cmr-label">2. DESTINATAIRE</span><div class="cmr-value" id="cmr-dest-addr"></div><div class="cmr-value" id="cmr-dest-contact"></div></div>
                <div class="cmr-box cmr-full"><span class="cmr-label">3. TRANSPORTEUR</span><div class="cmr-value">Chauffeur: <span id="cmr-driver-name"></span></div><div class="cmr-value">V√©hicule: <span id="cmr-plate"></span></div></div>
                <div class="cmr-box"><span class="cmr-label">4. ENL√àVEMENT</span><div class="cmr-value"><strong>Date:</strong> <span id="cmr-pickup-time"></span></div><div class="cmr-value"><strong>Lieu:</strong> <span id="cmr-pickup-loc"></span></div></div>
                <div class="cmr-box"><span class="cmr-label">5. LIVRAISON</span><div class="cmr-value"><strong>Date:</strong> <span id="cmr-delivery-time"></span></div><div class="cmr-value"><strong>Lieu:</strong> <span id="cmr-delivery-loc"></span></div></div>
            </div>
            <div class="cmr-full"><span class="cmr-label">6. MARCHANDISES</span><table class="cmr-table"><thead><tr><th width="10%">N¬∞</th><th width="40%">Nature</th><th width="15%">Poids (kg)</th><th width="35%">Remarques</th></tr></thead><tbody id="cmr-cargo-body"></tbody></table></div>
            <div class="cmr-sig-grid">
                <div class="cmr-sig-box"><span class="cmr-label">Signature Exp√©diteur</span><img id="cmr-img-sender" class="cmr-sig-img" src="" alt=""><div class="cmr-value" id="cmr-sender-name"></div></div>
                <div class="cmr-sig-box"><span class="cmr-label">Signature Chauffeur</span><img id="cmr-img-driver" class="cmr-sig-img" src="" alt=""></div>
                <div class="cmr-sig-box"><span class="cmr-label">Signature Destinataire</span><img id="cmr-img-recipient" class="cmr-sig-img" src="" alt=""><div id="cmr-recipient-placeholder" class="cmr-placeholder">En attente de livraison</div></div>
            </div>
            <div class="cmr-photos-page">
                <div class="page-break"></div>
                <div class="cmr-photos-header"><h2 style="text-align:center;margin:2rem 0 1rem 0;">PREUVES PHOTOGRAPHIQUES - LIVRAISON #<span id="cmr-photos-ref"></span></h2></div>
                <div class="photos-section" id="pickup-photos-section"><h3 style="background:#2563eb;color:white;padding:0.5rem;border-radius:4px;text-align:center;">üì∏ PHOTOS DE L'ENL√àVEMENT</h3><div class="photo-grid-large" id="cmr-pickup-photos"></div></div>
                <div class="photos-section" id="delivery-photos-section"><h3 style="background:#10b981;color:white;padding:0.5rem;border-radius:4px;text-align:center;margin-top:2rem;">üì∏ PHOTOS DE LA LIVRAISON</h3><div class="photo-grid-large" id="cmr-delivery-photos"></div></div>
                <div class="remarks-section" id="delivery-remarks-section"><h3 style="background:#f59e0b;color:white;padding:0.5rem;border-radius:4px;text-align:center;margin-top:2rem;">üìù REMARQUES & R√âSERVES</h3><div class="remarks-content" id="cmr-remarks-content"></div></div>
            </div>
        </div>
    </div>
    <script>
        // URL de l'API Google Apps Script
        const SHEET_API_URL_DIRECT = "https://script.google.com/macros/s/AKfycbzmBwZ8-REODwMexE2NooC2vDK6kr8t_PXcglZuRKMvNI7G5SvjKIAsaCfiIvN4U2BrHg/exec";
        
        // IMPORTANT : Les proxies CORS gratuits sont instables (403, 408)
        // Pour CMR automatique : h√©berger sur serveur local avec Python
        // Commande : python -m http.server 8000
        // Ou d√©sactiver temporairement l'auto-g√©n√©ration CMR
        
        // Pour l'instant : CMR manuel via bouton "Afficher CMR"
        const SHEET_API_URL = SHEET_API_URL_DIRECT;
        
        console.log('üìç API URL:', SHEET_API_URL);
        console.log('‚ö†Ô∏è CMR automatique d√©sactiv√© (n√©cessite serveur local pour √©viter CORS)');
        const app = {
            data: { deliveries: [], currentUser: null, filter: 'all', currentDelivery: null, isEditMode: false, wizard: { type: null, step: 1, currentItemPhotos: [], signatures: {}, cargoList: [], truckPlate: "", driverName: "", pads: {} }, syncQueue: [], isOnline: true },
            init: function() {
                try {
                    console.log("üöÄ Init v18.5 FINAL...");
                    const user = localStorage.getItem('currentUser');
                    
                    // ‚úÖ NE PAS charger donn√©es locales - toujours depuis Google Sheets
                    this.data.deliveries = [];
                    this.data.syncQueue = [];
                    
                    if (user) { this.data.currentUser = user; this.showDashboard(); }
                    this.checkOnlineStatus();
                    setTimeout(() => { this.loadDeliveries(); }, 1000);
                    window.addEventListener('online', () => this.setOnlineStatus(true));
                    window.addEventListener('offline', () => this.setOnlineStatus(false));
                } catch(error) { console.error("‚ùå Init error", error); this.showToast("Erreur init"); }
            },
            saveLocalData: function() {
                try { localStorage.setItem('deliveryApp_v18', JSON.stringify({ deliveries: this.data.deliveries, syncQueue: this.data.syncQueue, version: '18.5', timestamp: new Date().toISOString() })); } catch(e) { console.error("Save error:", e); this.showToast("‚ùå Erreur sauvegarde"); }
            },
            checkOnlineStatus: function() { const isOnline = navigator.onLine; this.setOnlineStatus(isOnline); return isOnline; },
            setOnlineStatus: function(isOnline) {
                this.data.isOnline = isOnline;
                const indicator = document.getElementById('sync-indicator');
                if (indicator) { indicator.textContent = isOnline ? 'En ligne' : 'Hors ligne'; indicator.className = `sync-status ${isOnline ? 'online' : 'offline'}`; }
                if (isOnline && this.data.syncQueue.length > 0) { this.showToast("Connexion OK - sync..."); this.processSyncQueue(); }
            },
            login: function() { const id = document.getElementById('login-id').value.trim(); if (id) { this.data.currentUser = id; localStorage.setItem('currentUser', id); this.showDashboard(); this.loadDeliveries(); } else { this.showToast("‚ùå ID requis"); } },
            logout: function() { this.data.currentUser = null; localStorage.removeItem('currentUser'); document.getElementById('app-container').classList.add('hidden'); document.getElementById('detail-view').style.display = 'none'; document.getElementById('login-screen').style.display = 'flex'; document.getElementById('login-id').value = ''; },
            showDashboard: function() { document.getElementById('login-screen').style.display = 'none'; document.getElementById('app-container').classList.remove('hidden'); document.getElementById('header-title').innerText = `Bonjour, ${this.data.currentUser}`; this.renderList(); },
            loadDeliveries: function() {
                if (!this.validateAPIUrl()) { this.renderList(); return; }
                document.getElementById('delivery-list').innerHTML = '<div style="text-align:center;padding:2rem;color:#6b7280">üîÑ Chargement...</div>';
                fetch(SHEET_API_URL).then(r => { if (!r.ok) throw new Error('Network'); return r.json(); }).then(data => { if (Array.isArray(data)) { this.data.deliveries = data; this.saveLocalData(); this.showToast(`‚úÖ ${data.length} livraisons charg√©es`); } else { console.error('Invalid:', data); } this.renderList(); }).catch(e => { console.error('Load error:', e); this.setOnlineStatus(false); this.renderList(); this.showToast("‚ùå Erreur connexion"); });
            },
            mergeDeliveries: function(serverData) {
                const serverMap = new Map();
                serverData.forEach(d => serverMap.set(d.id, d));
                this.data.deliveries.forEach((local, index) => { if (serverMap.has(local.id)) { const server = serverMap.get(local.id); if (new Date(server.lastUpdated) > new Date(local.lastUpdated)) { this.data.deliveries[index] = server; } serverMap.delete(local.id); } });
                serverMap.forEach(d => this.data.deliveries.push(d));
            },
            saveToGoogleSheets: function(delivery) {
                if (!this.validateAPIUrl()) { this.addToSyncQueue(delivery); return Promise.resolve(false); }
                console.log("üì§ Send:", delivery.id);
                return fetch(SHEET_API_URL, { method: 'POST', body: JSON.stringify([delivery]) }).then(r => r.json()).then(result => { console.log("‚úÖ OK:", result); return true; }).catch(e => { console.error("‚ùå Error:", e); this.addToSyncQueue(delivery); return false; });
            },
            addToSyncQueue: function(delivery) {
                this.data.syncQueue.push({ id: Date.now(), delivery: delivery, timestamp: new Date().toISOString(), retries: 0 });
                this.saveLocalData();
                this.setOnlineStatus(false);
                console.log("üìù Queue:", this.data.syncQueue.length);
            },
            processSyncQueue: function() {
                if (this.data.syncQueue.length === 0 || !this.data.isOnline) return;
                const item = this.data.syncQueue[0];
                this.saveToGoogleSheets(item.delivery).then(success => { if (success) { this.data.syncQueue.shift(); this.saveLocalData(); if (this.data.syncQueue.length > 0) { setTimeout(() => this.processSyncQueue(), 2000); } } else { item.retries++; if (item.retries > 3) { this.data.syncQueue.shift(); this.saveLocalData(); } } });
            },
            validateAPIUrl: function() { if (!SHEET_API_URL || SHEET_API_URL.includes('YOUR_DEPLOYMENT_ID')) { this.showToast("‚ùå URL API non config"); return false; } return true; },
            setFilter: function(filterType) {
                this.data.filter = filterType;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.filter-btn').forEach(btn => { if (btn.textContent.includes(filterType === 'all' ? 'Toutes' : filterType === 'pending' ? '√Ä enlever' : filterType === 'assigned' ? 'Assign√©es' : filterType === 'picked_up' ? 'En transit' : 'Livr√©es')) { btn.classList.add('active'); } });
                this.renderList();
            },
            renderList: function() {
                const container = document.getElementById('delivery-list');
                let filtered = this.data.deliveries;
                if (this.data.filter !== 'all') { filtered = filtered.filter(d => d.status === this.data.filter); }
                if (filtered.length === 0) { container.innerHTML = '<p style="text-align:center;color:#9ca3af;margin-top:2rem;">Aucune livraison</p>'; return; }
                container.innerHTML = filtered.map(d => this.createDeliveryCard(d)).join('');
            },
            formatDate: function(dateStr) {
                if (!dateStr) return '';
                try {
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return dateStr; // Si pas une date valide, retourner tel quel
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                } catch(e) {
                    return dateStr; // En cas d'erreur, retourner tel quel
                }
            },
            formatTime: function(timeStr) {
                if (!timeStr) return '';
                try {
                    // Si c'est d√©j√† du texte simple (ex: "Matin", "14h00"), retourner tel quel
                    if (!timeStr.includes('T') && !timeStr.includes('Z')) {
                        return timeStr;
                    }
                    // Si c'est un timestamp ISO, extraire l'heure
                    const date = new Date(timeStr);
                    if (isNaN(date.getTime())) return timeStr;
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${hours}h${minutes}`;
                } catch(e) {
                    return timeStr;
                }
            },
            createDeliveryCard: function(delivery) {
                const statusMap = { 'pending': { text: '√Ä enlever', class: 'pending' }, 'assigned': { text: 'Assign√©', class: 'assigned' }, 'picked_up': { text: 'En transit', class: 'picked_up' }, 'delivered': { text: 'Livr√©', class: 'delivered' } };
                const status = statusMap[delivery.status] || { text: delivery.status, class: 'pending' };
                
                // ‚úÖ v18.6: Cr√©neaux horaires avec formatage
                let scheduleHTML = '';
                if (delivery.pickupDate || delivery.pickupTime) {
                    const timeIcon = delivery.pickupTimeType === 'fixed' ? 'üîí' : '‚è∞';
                    const formattedDate = this.formatDate(delivery.pickupDate);
                    const formattedTime = this.formatTime(delivery.pickupTime);
                    scheduleHTML += `<div class="text-sm" style="color:#6366f1;margin-top:0.3rem">üìÖ Enl√®v: ${formattedDate} ${formattedTime ? timeIcon + ' ' + formattedTime : ''}</div>`;
                }
                if (delivery.deliveryDate || delivery.deliveryTime) {
                    const timeIcon = delivery.deliveryTimeType === 'fixed' ? 'üîí' : '‚è∞';
                    const formattedDate = this.formatDate(delivery.deliveryDate);
                    const formattedTime = this.formatTime(delivery.deliveryTime);
                    scheduleHTML += `<div class="text-sm" style="color:#059669;margin-top:0.3rem">üìÖ Livr: ${formattedDate} ${formattedTime ? timeIcon + ' ' + formattedTime : ''}</div>`;
                }
                
                return `<div class="card status-${delivery.status}" onclick="app.openDetail(${delivery.id})"><div class="card-header"><span style="font-weight:600">${delivery.nature || 'Livraison'}</span><span class="badge badge-${delivery.status}">${status.text}</span></div><div class="card-route"><span>üìç ${(delivery.fromAddr || '').split(',')[0] || 'Adresse manquante'}</span><span class="arrow-icon">‚Üì</span><span>üèÅ ${(delivery.toAddr || '').split(',')[0] || 'Adresse manquante'}</span></div>${scheduleHTML}<div class="text-sm">${delivery.driver ? `<strong>Chauffeur : ${delivery.driver}</strong>` : 'Non assign√©'}</div></div>`;
            },
            openDetail: function(id) {
                const delivery = this.data.deliveries.find(d => d.id === id);
                if (!delivery) { this.showToast("‚ùå Non trouv√©e"); return; }
                this.data.currentDelivery = delivery;
                const html = this.generateDetailHTML(delivery);
                document.getElementById('detail-content').innerHTML = html;
                document.getElementById('detail-view').style.display = 'block';
            },
            generateDetailHTML: function(delivery) {
                let html = `<h2 style="margin-top:0">${delivery.nature || 'Livraison'}</h2>`;
                html += `<div class="action-area">`;
                if (this.data.isEditMode) { 
                    html += `<button class="btn-action btn-save" onclick="app.saveDelivery()">üíæ Enregistrer</button>`;
                    html += `<button class="btn-action btn-cancel" onclick="app.cancelEdit()">‚ùå Annuler</button>`; 
                } else { 
                    html += `<button class="btn-action btn-edit" onclick="app.toggleEditMode()">‚úèÔ∏è Modifier</button>`; 
                }
                html += `</div>`;
                
                // ‚úÖ Formater les dates/heures pour affichage
                const formattedPickupDate = this.formatDate(delivery.pickupDate);
                const formattedPickupTime = this.formatTime(delivery.pickupTime);
                const formattedDeliveryDate = this.formatDate(delivery.deliveryDate);
                const formattedDeliveryTime = this.formatTime(delivery.deliveryTime);
                
                // üìç SECTION ENL√àVEMENT
                html += `<div class="info-block">`;
                html += `<h3>üìç Enl√®vement</h3>`;
                
                // Adresse
                html += `<div class="info-row"><span class="info-label">Adresse</span><div class="info-val-container">`;
                if (this.data.isEditMode) {
                    html += `<input type="text" id="edit-fromAddr" class="info-input" value="${delivery.fromAddr || ''}">`;
                } else {
                    html += `<span class="info-val">${delivery.fromAddr || 'Non sp√©cifi√©e'}</span>`;
                }
                html += `</div></div>`;
                
                // Contact
                html += `<div class="info-row"><span class="info-label">Contact</span><div class="info-val-container">`;
                if (this.data.isEditMode) {
                    html += `<input type="text" id="edit-fromContact" class="info-input" value="${delivery.fromContact || ''}">`;
                } else {
                    html += `<span class="info-val">${delivery.fromContact || 'Non sp√©cifi√©'}</span>`;
                }
                html += `</div></div>`;
                
                // Note
                html += `<div class="info-row"><span class="info-label">Note</span><div class="info-val-container">`;
                if (this.data.isEditMode) {
                    html += `<textarea id="edit-fromNote" class="info-input" style="text-align:left;height:60px">${delivery.fromNote || ''}</textarea>`;
                } else {
                    html += `<span class="info-val" style="text-align:left;${delivery.fromNote ? 'font-weight:600;' : ''}">${delivery.fromNote || 'Aucune'}</span>`;
                }
                html += `</div></div>`;
                
                // Cr√©neau Enl√®vement
                if (delivery.pickupDate || delivery.pickupTime) {
                    html += `<div class="info-row" style="background:#eff6ff;padding:0.75rem;border-radius:6px;margin-top:0.5rem">`;
                    html += `<span class="info-label">üìÖ Cr√©neau</span>`;
                    html += `<div class="info-val-container">`;
                    html += `<span class="info-val" style="font-weight:600">`;
                    html += `${formattedPickupDate || 'Date non d√©finie'}`;
                    if (formattedPickupTime) {
                        const icon = delivery.pickupTimeType === 'fixed' ? 'üîí' : '‚è∞';
                        html += ` ${icon} ${formattedPickupTime}`;
                    }
                    html += `</span>`;
                    html += `<span class="text-sm" style="color:#6366f1;display:block;margin-top:0.25rem">`;
                    html += delivery.pickupTimeType === 'fixed' ? 'Horaire fixe - √† respecter' : 'Horaire flexible';
                    html += `</span>`;
                    html += `</div></div>`;
                }
                
                // Date d'enl√®vement r√©elle
                if (delivery.history?.pickupTime) {
                    html += `<div class="text-sm mt-2" style="color:var(--success)">‚úÖ Enlev√© le ${new Date(delivery.history.pickupTime).toLocaleString()}</div>`;
                }
                
                html += `</div>`; // Fin info-block enl√®vement
                
                // üèÅ SECTION LIVRAISON
                html += `<div class="info-block">`;
                html += `<h3>üèÅ Livraison</h3>`;
                
                // Adresse
                html += `<div class="info-row"><span class="info-label">Adresse</span><div class="info-val-container">`;
                if (this.data.isEditMode) {
                    html += `<input type="text" id="edit-toAddr" class="info-input" value="${delivery.toAddr || ''}">`;
                } else {
                    html += `<span class="info-val">${delivery.toAddr || 'Non sp√©cifi√©e'}</span>`;
                }
                html += `</div></div>`;
                
                // Contact
                html += `<div class="info-row"><span class="info-label">Contact</span><div class="info-val-container">`;
                if (this.data.isEditMode) {
                    html += `<input type="text" id="edit-toContact" class="info-input" value="${delivery.toContact || ''}">`;
                } else {
                    html += `<span class="info-val">${delivery.toContact || 'Non sp√©cifi√©'}</span>`;
                }
                html += `</div></div>`;
                
                // Note
                html += `<div class="info-row"><span class="info-label">Note</span><div class="info-val-container">`;
                if (this.data.isEditMode) {
                    html += `<textarea id="edit-toNote" class="info-input" style="text-align:left;height:60px">${delivery.toNote || ''}</textarea>`;
                } else {
                    html += `<span class="info-val" style="text-align:left;${delivery.toNote ? 'font-weight:600;' : ''}">${delivery.toNote || 'Aucune'}</span>`;
                }
                html += `</div></div>`;
                
                // Cr√©neau Livraison
                if (delivery.deliveryDate || delivery.deliveryTime) {
                    html += `<div class="info-row" style="background:#d1fae5;padding:0.75rem;border-radius:6px;margin-top:0.5rem">`;
                    html += `<span class="info-label">üìÖ Cr√©neau</span>`;
                    html += `<div class="info-val-container">`;
                    html += `<span class="info-val" style="font-weight:600">`;
                    html += `${formattedDeliveryDate || 'Date non d√©finie'}`;
                    if (formattedDeliveryTime) {
                        const icon = delivery.deliveryTimeType === 'fixed' ? 'üîí' : '‚è∞';
                        html += ` ${icon} ${formattedDeliveryTime}`;
                    }
                    html += `</span>`;
                    html += `<span class="text-sm" style="color:#059669;display:block;margin-top:0.25rem">`;
                    html += delivery.deliveryTimeType === 'fixed' ? 'Horaire fixe - √† respecter' : 'Horaire flexible';
                    html += `</span>`;
                    html += `</div></div>`;
                }
                
                // Date de livraison r√©elle
                if (delivery.history?.deliveryTime) {
                    html += `<div class="text-sm mt-2" style="color:var(--success)">‚úÖ Livr√© le ${new Date(delivery.history.deliveryTime).toLocaleString()}</div>`;
                }
                
                html += `</div>`; // Fin info-block livraison
                
                // üìù NOTE G√âN√âRALE
                if (delivery.note || this.data.isEditMode) {
                    html += `<div class="info-block">`;
                    html += `<h3>üìù Note g√©n√©rale</h3>`;
                    html += `<div class="info-row"><span class="info-label">Note</span><div class="info-val-container">`;
                    if (this.data.isEditMode) {
                        html += `<textarea id="edit-note" class="info-input" style="text-align:left;height:60px">${delivery.note || ''}</textarea>`;
                    } else {
                        html += `<span class="info-val" style="text-align:left">${delivery.note || ''}</span>`;
                    }
                    html += `</div></div>`;
                    html += `</div>`;
                }
                
                // BOUTONS D'ACTION
                html += `<div class="action-area">`;
                html += this.generateActionButtons(delivery);
                html += `</div>`;
                
                return html;
            },
            generateActionButtons: function(delivery) {
                switch(delivery.status) {
                    case 'pending': return `<button class="btn-action btn-assign" onclick="app.assignDelivery(${delivery.id})">Prendre en charge</button>`;
                    case 'assigned': return `<button class="btn-action btn-pickup" onclick="app.startWizard('pickup', ${delivery.id})">üì¶ Commencer l'enl√®vement</button>`;
                    case 'picked_up': return `<button class="btn-action btn-deliver" onclick="app.startWizard('delivery', ${delivery.id})">üöö Commencer la livraison</button><button class="btn-action btn-cmr" onclick="app.showCMR(${delivery.id})">üìÑ Voir la CMR</button>`;
                    default: return `<div style="padding:1rem;background:#d1fae5;color:#059669;border-radius:8px;font-weight:600;">Livraison Termin√©e</div><button class="btn-action btn-cmr" onclick="app.showCMR(${delivery.id})">üìÑ Voir la CMR</button>`;
                }
            },
            toggleEditMode: function() { this.data.isEditMode = true; this.openDetail(this.data.currentDelivery.id); this.showToast("Mode √©dition"); },
            cancelEdit: function() { this.data.isEditMode = false; this.openDetail(this.data.currentDelivery.id); this.showToast("Annul√©"); },
            saveDelivery: function() {
                const delivery = this.data.currentDelivery;
                const fromAddr = document.getElementById('edit-fromAddr')?.value.trim() || '';
                const fromContact = document.getElementById('edit-fromContact')?.value.trim() || '';
                const toAddr = document.getElementById('edit-toAddr')?.value.trim() || '';
                const toContact = document.getElementById('edit-toContact')?.value.trim() || '';
                if (!fromAddr || !toAddr) { this.showToast("‚ùå Adresses obligatoires"); return; }
                delivery.fromAddr = fromAddr;
                delivery.fromContact = fromContact || "Non sp√©cifi√©";
                delivery.fromNote = document.getElementById('edit-fromNote')?.value || '';
                delivery.toAddr = toAddr;
                delivery.toContact = toContact || "Non sp√©cifi√©";
                delivery.toNote = document.getElementById('edit-toNote')?.value || '';
                delivery.note = document.getElementById('edit-note') ? document.getElementById('edit-note').value : '';
                delivery.lastUpdated = new Date().toISOString();
                this.data.isEditMode = false;
                this.saveLocalData();
                this.saveToGoogleSheets(delivery);
                this.openDetail(delivery.id);
                this.renderList();
                this.showToast("‚úÖ Mis √† jour");
            },
            closeDetail: function() { document.getElementById('detail-view').style.display = 'none'; this.data.currentDelivery = null; this.data.isEditMode = false; },
            assignDelivery: function(id) {
                const delivery = this.data.deliveries.find(d => d.id === id);
                if (!delivery) return;
                delivery.status = 'assigned';
                delivery.driver = this.data.currentUser;
                delivery.lastUpdated = new Date().toISOString();
                this.saveLocalData();
                this.saveToGoogleSheets(delivery);
                this.openDetail(id);
                this.renderList();
                this.showToast("‚úÖ Assign√©e!");
            },
            startWizard: function(type, id) {
                const delivery = this.data.deliveries.find(d => d.id === id);
                if (!delivery) return;
                this.data.currentDelivery = delivery;
                this.data.wizard = { type: type, step: 1, currentItemPhotos: [], signatures: {}, cargoList: [], truckPlate: "", driverName: this.data.currentUser, pads: {} };
                this.setupWizardSteps(type);
                this.resetWizardFields();
                document.getElementById('wizard-overlay').style.display = 'flex';
                this.updateWizardView();
                setTimeout(() => this.initSignaturePads(type), 500);
            },
            setupWizardSteps: function(type) {
                const stepsContainer = document.getElementById('wizard-steps');
                let stepsHtml = '';
                if (type === 'pickup') { stepsHtml = `<div class="step active" id="step-ind-1"><div class="step-circle">1</div>Photos</div><div class="step" id="step-ind-2"><div class="step-circle">2</div>Infos</div><div class="step" id="step-ind-3"><div class="step-circle">3</div>V√©hicule</div><div class="step" id="step-ind-4"><div class="step-circle">4</div>Exp√©diteur</div><div class="step" id="step-ind-5"><div class="step-circle">5</div>Chauffeur</div>`; } else { stepsHtml = `<div class="step active" id="step-ind-1"><div class="step-circle">1</div>Photos</div><div class="step" id="step-ind-2"><div class="step-circle">2</div>Destinataire</div><div class="step" id="step-ind-3"><div class="step-circle">3</div>Remarques</div>`; }
                stepsContainer.innerHTML = stepsHtml;
                document.getElementById('wizard-title').innerText = type === 'pickup' ? "Enl√®vement" : "Livraison";
            },
            resetWizardFields: function() {
                document.getElementById('photo-preview').innerHTML = '';
                document.getElementById('added-cargo-list').innerHTML = '';
                document.getElementById('cargo-count').innerText = '0';
                document.getElementById('cargo-nature').value = '';
                document.getElementById('cargo-weight').value = '';
                document.getElementById('cargo-remarks').value = '';
                document.getElementById('truck-plate').value = '';
                document.getElementById('driver-name-cmr').value = this.data.currentUser;
                document.getElementById('driver-name-sig').value = this.data.currentUser;
                if (this.data.wizard.type === 'pickup') { document.getElementById('sender-name').value = ''; } else { document.getElementById('recipient-name').value = ''; document.getElementById('delivery-condition').value = 'bon'; document.getElementById('delivery-remarks').value = ''; document.getElementById('actual-arrival-time').value = ''; document.getElementById('received-by').value = ''; document.getElementById('id-verified').value = 'oui'; }
            },
            initSignaturePads: function(type) { if (type === 'pickup') { this.createPad('sig-sender'); this.createPad('sig-driver'); } else { this.createPad('sig-recipient'); } },
            createPad: function(canvasId) {
                const canvas = document.getElementById(canvasId);
                if (!canvas || this.data.wizard.pads[canvasId]) return;
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                const ctx = canvas.getContext('2d');
                ctx.scale(ratio, ratio);
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                const pad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)', penColor: 'rgb(0, 0, 0)', minWidth: 0.5, maxWidth: 2.5, throttle: 16 });
                this.data.wizard.pads[canvasId] = pad;
                const resizeCanvas = () => { const ratio = Math.max(window.devicePixelRatio || 1, 1); canvas.width = canvas.offsetWidth * ratio; canvas.height = canvas.offsetHeight * ratio; canvas.getContext("2d").scale(ratio, ratio); pad.clear(); pad.backgroundColor = 'rgb(255, 255, 255)'; };
                window.addEventListener('resize', resizeCanvas);
                console.log(`‚úÖ Pad: ${canvasId}`);
            },
            clearSignature: function(canvasId) { const pad = this.data.wizard.pads[canvasId]; if (pad) { pad.clear(); console.log(`üßπ Clear: ${canvasId}`); } },
            handlePhotoUpload: function(input) {
                if (!input.files || input.files.length === 0) return;
                Array.from(input.files).forEach(file => {
                    if (file.size > 5 * 1024 * 1024) { this.showToast("‚ùå Photo trop volumineuse (max 5MB)"); return; }
                    this.compressAndAddPhoto(file);
                });
                input.value = '';
            },
            compressAndAddPhoto: function(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // R√©duction drastique pour √©viter erreur 50000 caract√®res
                        const maxWidth = 800;  // R√©duit de 1920 √† 800
                        const maxHeight = 600; // R√©duit de 1080 √† 600
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        // Qualit√© r√©duite √† 0.6 (au lieu de 0.8)
                        const compressed = canvas.toDataURL('image/jpeg', 0.6);
                        this.data.wizard.currentItemPhotos.push(compressed);
                        this.renderPhotoPreviews();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            },
            renderPhotoPreviews: function() {
                const container = document.getElementById('photo-preview');
                container.innerHTML = '';
                this.data.wizard.currentItemPhotos.forEach((src, idx) => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.className = 'photo-thumb';
                    img.onclick = () => { if (confirm("Supprimer ?")) { this.data.wizard.currentItemPhotos.splice(idx, 1); this.renderPhotoPreviews(); } };
                    container.appendChild(img);
                });
            },
            nextStep: function() {
                if (!this.validateCurrentStep()) return;
                const maxStep = this.data.wizard.type === 'pickup' ? 5 : 3;
                if (this.data.wizard.step < maxStep) { this.data.wizard.step++; this.updateWizardView(); } else { this.finishWizard(); }
            },
            prevStep: function() { if (this.data.wizard.step > 1) { this.data.wizard.step--; this.updateWizardView(); } },
            validateCurrentStep: function() {
                const step = this.data.wizard.step;
                const type = this.data.wizard.type;
                if (step === 1 && this.data.wizard.currentItemPhotos.length === 0) { this.showToast("‚ùå Prenez au moins une photo"); return false; }
                if (step === 2 && type === 'pickup') { 
                    // ‚úÖ MODIFICATION : V√©rifier qu'au moins 1 colis a √©t√© ajout√©
                    if (this.data.wizard.cargoList.length === 0) { 
                        this.showToast("‚ùå Vous devez ajouter au moins 1 colis"); 
                        return false; 
                    }
                }
                if (step === 3 && type === 'pickup') { const plate = document.getElementById('truck-plate').value.trim(); if (!plate) { this.showToast("‚ùå Plaque requise"); return false; } this.data.wizard.truckPlate = plate; }
                if (step === 4 && type === 'pickup') { const senderName = document.getElementById('sender-name').value.trim(); const senderPad = this.data.wizard.pads['sig-sender']; if (!senderName) { this.showToast("‚ùå Nom exp√©diteur requis"); return false; } if (!senderPad || senderPad.isEmpty()) { this.showToast("‚ùå Signature exp√©diteur requise"); return false; } this.data.wizard.signatures.senderName = senderName; this.data.wizard.signatures.senderSig = senderPad.toDataURL(); }
                if (step === 5 && type === 'pickup') { const driverPad = this.data.wizard.pads['sig-driver']; if (!driverPad || driverPad.isEmpty()) { this.showToast("‚ùå Signature chauffeur requise"); return false; } this.data.wizard.signatures.driverSig = driverPad.toDataURL(); }
                if (step === 2 && type === 'delivery') { const recipientName = document.getElementById('recipient-name').value.trim(); const recipientPad = this.data.wizard.pads['sig-recipient']; if (!recipientName) { this.showToast("‚ùå Nom destinataire requis"); return false; } this.data.wizard.signatures.recipientName = recipientName; if (recipientPad && !recipientPad.isEmpty()) { this.data.wizard.signatures.recipientSig = recipientPad.toDataURL(); } }
                if (step === 3 && type === 'delivery') { const receivedBy = document.getElementById('received-by').value.trim(); if (!receivedBy) { this.showToast("‚ùå Nom r√©ceptionnaire requis"); return false; } this.data.wizard.signatures.receivedBy = receivedBy; }
                return true;
            },
            updateWizardView: function() {
                document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
                const step = this.data.wizard.step;
                const type = this.data.wizard.type;
                let activeSection = '';
                if (step === 1) activeSection = 'step-1';
                else if (step === 2) activeSection = type === 'pickup' ? 'step-2-details' : 'step-2-recipient';
                else if (step === 3) activeSection = type === 'pickup' ? 'step-3-transport' : 'step-3-remarks';
                else if (step === 4) activeSection = 'step-4-sender';
                else if (step === 5) activeSection = 'step-5-driver';
                if (activeSection) { document.getElementById(activeSection).classList.add('active'); }
                document.querySelectorAll('.step').forEach((el, idx) => { el.classList.remove('active', 'completed'); if (idx + 1 < step) el.classList.add('completed'); if (idx + 1 === step) el.classList.add('active'); });
                const maxStep = type === 'pickup' ? 5 : 3;
                const nextBtn = document.getElementById('btn-next');
                const prevBtn = document.getElementById('btn-prev');
                prevBtn.style.display = step === 1 ? 'none' : 'block';
                nextBtn.innerText = step === maxStep ? "Valider & Terminer" : "Suivant";
                nextBtn.style.backgroundColor = step === maxStep ? "var(--success)" : "var(--primary)";
                
                // ‚úÖ MODIFICATION : D√©sactiver le bouton Suivant si √©tape 2 pickup et aucun colis
                if (step === 2 && type === 'pickup') {
                    if (this.data.wizard.cargoList.length === 0) {
                        nextBtn.disabled = true;
                        nextBtn.style.opacity = '0.5';
                        nextBtn.style.cursor = 'not-allowed';
                    } else {
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                        nextBtn.style.cursor = 'pointer';
                    }
                } else {
                    nextBtn.disabled = false;
                    nextBtn.style.opacity = '1';
                    nextBtn.style.cursor = 'pointer';
                }
            },
            addCargoToManifest: function() {
                const nature = document.getElementById('cargo-nature').value.trim();
                const weight = document.getElementById('cargo-weight').value.trim();
                const remarks = document.getElementById('cargo-remarks').value.trim();
                if (!nature || !weight) { this.showToast("‚ùå Nature et poids requis"); return; }
                const cargo = { nature: nature, weight: parseFloat(weight) || 0, remarks: remarks, photos: [...this.data.wizard.currentItemPhotos] };
                this.data.wizard.cargoList.push(cargo);
                document.getElementById('cargo-count').innerText = this.data.wizard.cargoList.length;
                const list = document.getElementById('added-cargo-list');
                list.innerHTML += `<li>${nature} (${weight}kg) ${remarks ? '- ' + remarks : ''}</li>`;
                document.getElementById('cargo-nature').value = '';
                document.getElementById('cargo-weight').value = '';
                document.getElementById('cargo-remarks').value = '';
                this.data.wizard.currentItemPhotos = [];
                document.getElementById('photo-preview').innerHTML = '';
                this.showToast("‚úÖ Colis ajout√©");
                
                // ‚úÖ MODIFICATION : Activer le bouton Suivant maintenant qu'un colis est ajout√©
                this.updateWizardView();
            },
            closeWizard: function() { if (confirm("Annuler ?")) { document.getElementById('wizard-overlay').style.display = 'none'; this.data.wizard.pads = {}; } },
            finishWizard: function() { this.getCurrentLocation().then(location => { this.completeWizardProcess(location); }); },
            getCurrentLocation: function() {
                return new Promise((resolve) => {
                    if (!navigator.geolocation) { resolve(null); return; }
                    navigator.geolocation.getCurrentPosition(p => { resolve({ lat: p.coords.latitude, lng: p.coords.longitude, accuracy: p.coords.accuracy }); }, e => { console.warn("GPS:", e); resolve(null); }, { enableHighAccuracy: true, timeout: 10000 });
                });
            },
            completeWizardProcess: async function(location) {
                const delivery = this.data.currentDelivery;
                const wizard = this.data.wizard;
                const now = new Date().toISOString();
                const locationStr = location ? `${location.lat},${location.lng}` : "GPS indisponible";
                delivery.history = delivery.history || {};
                if (wizard.type === 'pickup') {
                    delivery.status = 'picked_up';
                    delivery.history.pickupTime = now;
                    delivery.history.pickupLoc = locationStr;
                    delivery.history.pickupPlate = wizard.truckPlate;
                    delivery.history.senderName = wizard.signatures.senderName;
                    delivery.history.senderSig = wizard.signatures.senderSig;
                    delivery.history.driverSig = wizard.signatures.driverSig;
                    delivery.history.cargo = [...wizard.cargoList];
                } else {
                    delivery.status = 'delivered';
                    delivery.history.deliveryTime = now;
                    delivery.history.deliveryLoc = locationStr;
                    delivery.history.recipientName = wizard.signatures.recipientName;
                    delivery.history.recipientSig = wizard.signatures.recipientSig;
                    delivery.history.deliveryPhotos = [...wizard.currentItemPhotos];
                    delivery.history.deliveryRemarks = { condition: document.getElementById('delivery-condition').value, remarks: document.getElementById('delivery-remarks').value, actualArrivalTime: document.getElementById('actual-arrival-time').value, receivedBy: document.getElementById('received-by').value, idVerified: document.getElementById('id-verified').value };
                    if (wizard.signatures.receivedBy) { delivery.toContact = wizard.signatures.receivedBy; }
                    
                    // ‚úÖ NOUVEAU v18.7 : G√©n√©rer et archiver CMR automatiquement
                    // v18.7: CMR g√©n√©r√© automatiquement c√¥t√© serveur lors de la sync
                    // Plus besoin d'appel depuis le navigateur (√©vite probl√®me CORS)
                    // await this.generateAndArchiveCMR(delivery);
                }
                delivery.lastUpdated = now;
                this.saveLocalData();
                this.saveToGoogleSheets(delivery);
                document.getElementById('wizard-overlay').style.display = 'none';
                this.openDetail(delivery.id);
                this.renderList();
                this.showToast(`‚úÖ ${wizard.type === 'pickup' ? 'Enl√®vement' : 'Livraison'} enregistr√© !`);
            },
            generateAndArchiveCMR: async function(delivery) {
                // G√©n√©rer et archiver CMR automatiquement (silencieux)
                console.log('üé´ [CMR] D√©but g√©n√©ration automatique...');
                console.log('üé´ [CMR] Delivery ID:', delivery.id);
                console.log('üé´ [CMR] Nature:', delivery.nature);
                console.log('üé´ [CMR] Driver:', delivery.driver);
                
                try {
                    // Si CMR d√©j√† g√©n√©r√©, ne pas r√©g√©n√©rer
                    if (delivery.cmrNumber && delivery.cmrNumber.startsWith('CMR-')) {
                        console.log('üé´ [CMR] D√©j√† g√©n√©r√©:', delivery.cmrNumber);
                        return;
                    }
                    
                    // Pr√©parer les donn√©es minimales pour l'archive
                    const deliveryData = {
                        nature: delivery.nature || 'Non sp√©cifi√©',
                        driver: delivery.driver || this.data.currentUser || 'Inconnu',
                        fromAddr: delivery.fromAddr || 'Non sp√©cifi√©',
                        toAddr: delivery.toAddr || 'Non sp√©cifi√©',
                        status: 'delivered'
                    };
                    
                    console.log('üé´ [CMR] Donn√©es pr√©par√©es:', deliveryData);
                    
                    // Encoder les donn√©es pour l'URL
                    const encodedData = encodeURIComponent(JSON.stringify(deliveryData));
                    console.log('üé´ [CMR] Donn√©es encod√©es:', encodedData.substring(0, 100) + '...');
                    
                    // Construire URL compl√®te
                    const url = SHEET_API_URL + '&action=get_cmr_number&delivery=' + encodedData;
                    console.log('üé´ [CMR] URL appel√©e:', url.substring(0, 150) + '...');
                    
                    // Appel API avec les donn√©es
                    console.log('üé´ [CMR] Appel API en cours...');
                    const response = await fetch(url);
                    console.log('üé´ [CMR] R√©ponse re√ßue, status:', response.status);
                    
                    const data = await response.json();
                    console.log('üé´ [CMR] Donn√©es re√ßues:', data);
                    
                    if (data.status === 'success' && data.data && data.data.cmrNumber) {
                        delivery.cmrNumber = data.data.cmrNumber;
                        console.log('‚úÖ CMR g√©n√©r√© automatiquement:', delivery.cmrNumber);
                        console.log('‚úÖ Archiv√©:', data.data.archived);
                    } else {
                        console.warn('‚ö†Ô∏è Erreur g√©n√©ration CMR:', data.message || 'Pas de CMR dans r√©ponse');
                        console.warn('‚ö†Ô∏è R√©ponse compl√®te:', data);
                    }
                } catch (error) {
                    console.error('‚ùå Erreur g√©n√©ration CMR automatique:', error);
                    console.error('‚ùå Message:', error.message);
                    console.error('‚ùå Stack:', error.stack);
                    // Pas de message √† l'utilisateur, le CMR sera g√©n√©r√© manuellement si besoin
                }
            },
            showCMR: async function(id) { 
                const delivery = this.data.deliveries.find(d => d.id === id); 
                if (!delivery) {
                    this.showToast('‚ùå Livraison introuvable');
                    return;
                }
                
                console.log('üìã [showCMR] Delivery trouv√©e:', delivery.id);
                console.log('üìã [showCMR] Nature:', delivery.nature);
                console.log('üìã [showCMR] Driver:', delivery.driver);
                console.log('üìã [showCMR] FromAddr:', delivery.fromAddr);
                
                // Chercher le vrai num√©ro CMR dans CMR_Archive
                this.showToast('üîÑ Recherche du CMR dans l\'archive...');
                
                try {
                    // Pr√©parer les param√®tres de recherche
                    const params = new URLSearchParams({
                        action: 'get_cmr_for_delivery',
                        nature: delivery.nature || '',
                        driver: delivery.driver || '',
                        fromAddr: delivery.fromAddr || ''
                    });
                    
                    console.log('üîç Recherche CMR avec params:', params.toString());
                    
                    // Appeler l'API
                    const response = await fetch(SHEET_API_URL + '&' + params.toString());
                    
                    if (!response.ok) {
                        throw new Error('Erreur r√©seau: ' + response.status);
                    }
                    
                    const result = await response.json();
                    console.log('üì° R√©ponse API:', result);
                    
                    // V√©rifier si CMR trouv√©
                    if (result.status === 'success' && result.data && result.data.cmrNumber) {
                        delivery.cmrNumber = result.data.cmrNumber;
                        console.log('‚úÖ CMR trouv√©:', delivery.cmrNumber);
                        this.showToast('‚úÖ CMR: ' + delivery.cmrNumber);
                    } else {
                        // CMR pas encore g√©n√©r√©
                        delivery.cmrNumber = 'En attente de g√©n√©ration';
                        console.log('‚è≥ CMR pas encore disponible');
                        this.showToast('‚è≥ CMR en cours de g√©n√©ration - r√©essayez dans quelques secondes');
                    }
                    
                    // Afficher le PDF
                    this.populateCMRView(delivery);
                    document.getElementById('cmr-view').style.display = 'block';
                    
                } catch (error) {
                    console.error('‚ùå Erreur recherche CMR:', error);
                    
                    // Fallback : utiliser l'ID comme num√©ro temporaire
                    delivery.cmrNumber = 'CMR-' + String(delivery.id).padStart(6, '0') + ' (temporaire)';
                    this.showToast('‚ö†Ô∏è CMR temporaire - r√©essayez pour obtenir le num√©ro officiel');
                    
                    this.populateCMRView(delivery);
                    document.getElementById('cmr-view').style.display = 'block';
                }
            },
            populateCMRView: function(delivery) {
                document.getElementById('cmr-ref').textContent = delivery.cmrNumber || 'CMR-0000';
                document.getElementById('cmr-sender-addr').textContent = delivery.fromAddr || '';
                document.getElementById('cmr-sender-contact').textContent = delivery.fromContact || '';
                document.getElementById('cmr-dest-addr').textContent = delivery.toAddr || '';
                document.getElementById('cmr-dest-contact').textContent = delivery.toContact || '';
                document.getElementById('cmr-driver-name').textContent = delivery.driver || this.data.currentUser;
                document.getElementById('cmr-plate').textContent = delivery.history?.pickupPlate || '';
                document.getElementById('cmr-pickup-time').textContent = delivery.history?.pickupTime ? new Date(delivery.history.pickupTime).toLocaleString() : '-';
                document.getElementById('cmr-delivery-time').textContent = delivery.history?.deliveryTime ? new Date(delivery.history.deliveryTime).toLocaleString() : 'En attente';
                document.getElementById('cmr-pickup-loc').textContent = delivery.history?.pickupLoc || 'N/A';
                document.getElementById('cmr-delivery-loc').textContent = delivery.history?.deliveryLoc || 'N/A';
                document.getElementById('cmr-photos-ref').textContent = delivery.cmrNumber || delivery.id;
                this.populateCMRGoods(delivery);
                this.populateCMRSignatures(delivery);
                this.populateCMRPhotos(delivery);
                this.populateCMRRemarks(delivery);
            },
            populateCMRGoods: function(delivery) {
                const tbody = document.getElementById('cmr-cargo-body');
                tbody.innerHTML = '';
                const cargoList = delivery.history?.cargo || [];
                if (cargoList.length > 0) { cargoList.forEach((cargo, idx) => { tbody.innerHTML += `<tr><td>${idx + 1}</td><td>${cargo.nature || ''}</td><td>${cargo.weight || ''}</td><td>${cargo.remarks || ''}</td></tr>`; }); } else { tbody.innerHTML = `<tr><td>1</td><td>${delivery.nature || 'Marchandise'}</td><td>-</td><td>-</td></tr>`; }
            },
            populateCMRSignatures: function(delivery) {
                const senderImg = document.getElementById('cmr-img-sender');
                const driverImg = document.getElementById('cmr-img-driver');
                const recipientImg = document.getElementById('cmr-img-recipient');
                const recipientPlaceholder = document.getElementById('cmr-recipient-placeholder');
                if (delivery.history?.senderSig) { senderImg.src = delivery.history.senderSig; senderImg.style.display = 'block'; document.getElementById('cmr-sender-name').textContent = delivery.history.senderName || ''; } else { senderImg.style.display = 'none'; }
                if (delivery.history?.driverSig) { driverImg.src = delivery.history.driverSig; driverImg.style.display = 'block'; } else { driverImg.style.display = 'none'; }
                if (delivery.history?.recipientSig) { recipientImg.src = delivery.history.recipientSig; recipientImg.style.display = 'block'; recipientPlaceholder.style.display = 'none'; } else { recipientImg.style.display = 'none'; recipientPlaceholder.style.display = 'block'; }
            },
            populateCMRPhotos: function(delivery) {
                const pickupPhotosGrid = document.getElementById('cmr-pickup-photos');
                const deliveryPhotosGrid = document.getElementById('cmr-delivery-photos');
                pickupPhotosGrid.innerHTML = '';
                deliveryPhotosGrid.innerHTML = '';
                if (delivery.history?.cargo) { delivery.history.cargo.forEach((cargo, cargoIndex) => { if (cargo.photos && cargo.photos.length > 0) { cargo.photos.forEach((photo, photoIndex) => { if (photo) { const img = document.createElement('img'); img.src = photo; img.className = 'cmr-photo-large'; img.alt = `Enl√®vement - Colis ${cargoIndex + 1} - Photo ${photoIndex + 1}`; pickupPhotosGrid.appendChild(img); } }); } }); }
                if (delivery.history?.deliveryPhotos) { delivery.history.deliveryPhotos.forEach((photo, index) => { if (photo) { const img = document.createElement('img'); img.src = photo; img.className = 'cmr-photo-large'; img.alt = `Livraison - Photo ${index + 1}`; deliveryPhotosGrid.appendChild(img); } }); }
                document.getElementById('pickup-photos-section').style.display = pickupPhotosGrid.children.length > 0 ? 'block' : 'none';
                document.getElementById('delivery-photos-section').style.display = deliveryPhotosGrid.children.length > 0 ? 'block' : 'none';
            },
            populateCMRRemarks: function(delivery) {
                const remarksContent = document.getElementById('cmr-remarks-content');
                if (delivery.history?.deliveryRemarks) {
                    const remarks = delivery.history.deliveryRemarks;
                    const conditionMap = { 'bon': { text: '‚úÖ Bon √©tat', color: '#10b981' }, 'endommage': { text: '‚ö†Ô∏è L√©g√®rement endommag√©', color: '#f59e0b' }, 'tres_endommage': { text: '‚ùå Tr√®s endommag√©', color: '#ef4444' }, 'manquant': { text: 'üì¶ Pi√®ce(s) manquante(s)', color: '#dc2626' } };
                    const idVerifiedMap = { 'oui': '‚úÖ Oui', 'non': '‚ùå Non', 'refus': 'üö´ A refus√©' };
                    remarksContent.innerHTML = `<div class="remark-item"><span class="remark-label">√âtat de la marchandise</span><span class="remark-value" style="color:${conditionMap[remarks.condition]?.color || '#000'}">${conditionMap[remarks.condition]?.text || remarks.condition}</span></div><div class="remark-item"><span class="remark-label">Remarques d√©taill√©es</span><span class="remark-value">${remarks.remarks || 'Aucune'}</span></div><div class="remark-item"><span class="remark-label">Heure d'arriv√©e r√©elle</span><span class="remark-value">${remarks.actualArrivalTime || 'Non renseign√©e'}</span></div><div class="remark-item"><span class="remark-label">R√©ceptionn√© par</span><span class="remark-value">${remarks.receivedBy || 'Non renseign√©'}</span></div><div class="remark-item"><span class="remark-label">Pi√®ce d'identit√© v√©rifi√©e</span><span class="remark-value">${idVerifiedMap[remarks.idVerified] || remarks.idVerified}</span></div>`;
                    document.getElementById('delivery-remarks-section').style.display = 'block';
                } else { document.getElementById('delivery-remarks-section').style.display = 'none'; }
            },
            testConnection: function() { if (!this.validateAPIUrl()) { alert("URL non config"); return; } this.showToast("Test connexion..."); fetch(SHEET_API_URL).then(r => r.json()).then(data => { alert(`‚úÖ OK!\n\nLivraisons: ${Array.isArray(data) ? data.length : 'N/A'}`); }).catch(e => { alert(`‚ùå Erreur: ${e.message}`); }); },
            testWrite: function() {
                if (!this.validateAPIUrl()) { alert("URL non config"); return; }
                const testDelivery = { id: Date.now(), nature: "TEST v18.5 " + new Date().toLocaleTimeString(), status: "pending", driver: this.data.currentUser || "Test", fromAddr: "Test enl√®vement", fromContact: "Contact test", fromNote: "Note test", toAddr: "Test livraison", toContact: "Contact test", toNote: "Note test", note: "Note test", history: {}, lastUpdated: new Date().toISOString() };
                this.saveToGoogleSheets(testDelivery).then(success => { if (success) { alert("‚úÖ Test OK !"); this.loadDeliveries(); } else { alert("‚ö†Ô∏è En attente"); } });
            },
            forceReloadFromSheet: function() { 
                console.log("üîÑ RECHARGEMENT depuis Google Sheets");
                this.data.deliveries = []; 
                this.loadDeliveries(); 
            },
            showToast: function(message) { const toast = document.getElementById("toast"); toast.textContent = message; toast.className = "show"; setTimeout(() => { toast.className = ""; }, 3000); }
        };
        app.init();
    </script>
</body>
</html>
